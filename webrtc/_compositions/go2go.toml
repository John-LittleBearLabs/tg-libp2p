[metadata]
  name = "go2go {{ .Env.GitReference }}"

[global]
  plan = "libp2p/webrtc"
  case = "webrtc"
  builder = "docker:go"
  runner = "local:docker"
  total_instances = 2

  [global.build_config]
    enable_go_build_cache  = true # TODO set back to false, see https://github.com/testground/testground/issues/1361
    # TODO restore disable testground's goproxy which hangs on github runners.
    #go_proxy_mode          = "remote"
    #go_proxy_url           = "https://proxy.golang.org"

[[groups]]
  id = "server"
  instances = { count = 1 }
  builder = "docker:go" # override builder here

  [groups.build_config]
    path = "go/" # define base path here
    build_args = { image = "golang:1.19-bullseye" }

  [groups.run.test_params]
    expected_implementation = "go"

  [groups.build_config.dockerfile_extensions]
    pre_build = "RUN echo client prebuild"

[[groups]]
  id = "client"
  instances = { count = 1 }
  builder = "docker:go" # override builder here

  [groups.build_config]
    path = "go/" # define base path here
    build_args = { image = "golang:1.19-bullseye" }

  [groups.run.test_params]
    expected_implementation = "go"

  [groups.build_config.dockerfile_extensions]
    pre_build = "RUN echo client prebuild"

#{{ with (load_resource "./go.toml" ) }}
  #{{ range .groups }}
    #[[groups]]
    #id = "{{ .Id }}"
    #instances = { count = 1 }

    #[groups.build]
      #selectors = ['{{ .Selector }}']

    #[groups.build_config]
      #build_base_image = 'golang:{{ .GoVersion }}-buster'
      #modfile = "{{ .Modfile }}"
  #{{ end }}

  #{{ with .master }}
    #[[groups]]
    #id = "master"
    #instances = { count = 1 }

    #[groups.build]
      #selectors = ['{{ .Selector }}']

      #[[groups.build.dependencies]]
        #module = "github.com/John-LittleBearLabs/go-libp2p"
        #version = "v1.2.5"

    #[groups.build_config]
      #build_base_image = 'golang:{{ .GoVersion }}-buster'
      #modfile = "{{ .Modfile }}"

    #[groups.build_config.dockerfile_extensions]
      ## deal with dependency changes in master until we create the new vx.y.z instance
      #pre_build = """
        #RUN echo 'master prebuild' && cd ${PLAN_DIR} && \
            #go mod download github.com/John-LittleBearLabs/go-libp2p

        #RUN cd ${PLAN_DIR} && \
            #go mod tidy -compat={{ .GoVersion }}
        #"""
  #{{ end }}

  #{{ if $.Env.GitReference }}
    #{{ with .custom }}
      #[[groups]]
      #id = "custom"
      #instances = { count = 1 }

      #[groups.build]
        #selectors = ['{{ .Selector }}']

      #[[groups.build.dependencies]]
        #module = "github.com/John-LittleBearLabs/go-libp2p"
        #version = "v1.2.6"
        #{{ if $.Env.GitTarget }}
        #target = "{{ $.Env.GitTarget }}"
        #{{ end }}

      #[groups.build_config]
        #build_base_image = 'golang:{{ .GoVersion }}-buster'
        #modfile = "{{ .Modfile }}"

      #[groups.build_config.dockerfile_extensions]
        ## deal with dependency changes in master until we create the new vx.y.z instance
        #pre_build = """
          #RUN echo 'custom prebuild' && cd ${PLAN_DIR} && \
              #go mod download github.com/John-LittleBearLabs/go-libp2p

          #RUN cd ${PLAN_DIR} && \
              #go mod tidy -compat={{ .GoVersion }}
          #"""
    #{{ end }}
  #{{ end }}
#{{ end }}
