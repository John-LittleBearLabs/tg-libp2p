name: Interop Dashboard

on:
  push:
  pull_request:
jobs:
  run_test:
    name: Run the composer script
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Setup tmate session
        uses: pl-strflt/action-tmate@circleci
        if: runner.debug == '1'
        with:
          check-num-clients: true
          limit-access-to-actor: true # requires registered public SSH key(s)
          wait: false
          wait-in-post: true
          wait-interval: '600000' # 10 minutes
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          path: test-plans
          repository: ${{ env.TEST_PLAN_REPO }}
          ref: ${{ env.TEST_PLAN_BRANCH }}
      - name: setup testground
        uses: ./test-plans/.github/actions/setup-testground
        with:
          testground_ref: 'feat/support-interop-matrix'
      - name: Import the plan
        working-directory: ./test-plans
        run: |
          testground plan import --from ./ --name libp2p
      - name: Prepare the composer
        working-directory: ./test-plans/composer
        run: npm ci
      - name: Build
        working-directory: ./test-plans/composer
        run: |
          for i in 1 2 3; do
            echo "=== Attempt $i ==="
            make /tmp/builds-artifacts.toml && exit 0
            sleep 1
          done
          exit 1
      - name: Run & Generate the results
        working-directory: ./test-plans/composer
        run: |
          for i in 1 2 3; do
            echo "=== Attempt $i ==="
            make ./demo/results.csv && exit 0
            sleep 1
          done
          exit 1
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: interop-result
          path: |
            ~/test-plans/composer/demo/results.csv
      - uses: actions/upload-artifact@v3
        if: ${{ failure() }}
        with:
          name: testground-output
          path: |
            ~/testground/
            ~/test-plans/result.tgz
            ${{env.COMPOSITION_FILE}}
            testground.*
            test-plans/*.out
